<script src="https://unpkg.com/@hotwired/turbo@7.0.0-beta.1/dist/turbo.es5-umd.js"></script>
<script src="https://unpkg.com/reconnecting-websocket@4.4.0/dist/reconnecting-websocket-cjs.js"></script>
<script>
const socket = new ReconnectingWebSocket("ws://localhost:8000/ws/")

class TurboChannelsStreamSource extends HTMLElement {
    static counter = 0;
    request_id;

    constructor() {
      super();
      this.request_id = TurboChannelsStreamSource.counter++
    }

    async connectedCallback() {
      Turbo.connectStreamSource(this)

      socket.addEventListener("open", e => {
        socket.send(JSON.stringify({
          request_id: this.request_id,
          type: "subscribe",
          ...this.subscription
        }))
      })

      socket.addEventListener("message", e => {
        const broadcast = JSON.parse(e.data)
        if (broadcast.request_id === this.request_id) {
          this.dispatchMessageEvent(broadcast.data)
        }
      })
    }

    disconnectedCallback() {
      socket.send(JSON.stringify({
        request_id: this.request_id,
        type: "unsubscribe"
      }))
      Turbo.disconnectStreamSource(this)
    }

    dispatchMessageEvent(data) {
        const event = new MessageEvent("message", { data })
        return this.dispatchEvent(event)
    }

    get subscription() {
      const signed_channel_name = this.getAttribute("signed-channel-name")

      return { signed_channel_name }
    }
}

customElements.define("turbo-channels-stream-source", TurboChannelsStreamSource)
</script>
